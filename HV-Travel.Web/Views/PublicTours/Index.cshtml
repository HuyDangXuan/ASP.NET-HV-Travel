@model List<Tour>
@{
    ViewData["Description"] = "Khám phá tất cả tour du lịch Việt Nam tại HV Travel";
    var currentCategory = ViewData["CurrentCategory"]?.ToString();
    var currentSearch = ViewData["CurrentSearch"]?.ToString();
    var currentSort = ViewData["CurrentSort"]?.ToString();
    var categories = ViewData["Categories"] as List<string> ?? new List<string>();
    var currentPage = (int)(ViewData["CurrentPage"] ?? 1);
    var totalPages = (int)(ViewData["TotalPages"] ?? 1);
    var totalItems = (int)(ViewData["TotalItems"] ?? 0);
}

<!-- Hero -->
<section class="hero-gradient relative overflow-hidden">
    <div class="absolute inset-0 opacity-15">
        <div class="absolute top-20 left-20 w-72 h-72 bg-primary/30 rounded-full blur-3xl"></div>
    </div>
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-20 relative z-10 text-center" data-animate="fade-up">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-white leading-tight mb-4">
            Tour <span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-cyan-300">Du Lịch</span>
        </h1>
        <p class="text-lg text-slate-300 max-w-xl mx-auto mb-8">Tìm kiếm hành trình hoàn hảo dành cho bạn</p>
        <!-- Search Bar -->
        <form asp-controller="PublicTours" asp-action="Index" method="get" class="max-w-2xl mx-auto">
            <input type="hidden" name="category" value="@currentCategory" />
            <input type="hidden" name="sort" value="@currentSort" />
            <div class="flex bg-white/10 backdrop-blur-md rounded-2xl border border-white/20 overflow-hidden">
                <input type="text" name="search" value="@currentSearch" placeholder="Tìm kiếm tour, điểm đến..."
                       class="flex-1 bg-transparent text-white placeholder-white/60 px-6 py-4 text-sm outline-none" />
                <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-8 py-4 font-bold text-sm transition-colors flex items-center gap-2">
                    <span class="material-symbols-outlined text-[20px]">search</span>
                    <span class="hidden sm:inline">Tìm Kiếm</span>
                </button>
            </div>
        </form>
    </div>
</section>

<!-- Content -->
<section class="py-12 bg-background-light dark:bg-background-dark">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Filters Bar -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8" data-animate="fade-in">
            <div class="flex flex-wrap items-center gap-2">
                <a asp-controller="PublicTours" asp-action="Index" asp-route-search="@currentSearch" asp-route-sort="@currentSort"
                   class="px-4 py-2 rounded-xl text-sm font-semibold transition-all @(string.IsNullOrEmpty(currentCategory) ? "bg-primary text-white shadow-lg shadow-primary/25" : "bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-700 hover:ring-primary/30")">
                    Tất Cả
                </a>
                @foreach (var cat in categories)
                {
                    <a asp-controller="PublicTours" asp-action="Index" asp-route-category="@cat" asp-route-search="@currentSearch" asp-route-sort="@currentSort"
                       class="px-4 py-2 rounded-xl text-sm font-semibold transition-all @(currentCategory == cat ? "bg-primary text-white shadow-lg shadow-primary/25" : "bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-700 hover:ring-primary/30")">
                        @cat
                    </a>
                }
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm text-slate-500 dark:text-slate-400">@totalItems tour</span>
                <select id="sort-select" class="bg-white dark:bg-slate-800 text-sm text-slate-700 dark:text-slate-300 px-4 py-2 rounded-xl ring-1 ring-slate-200 dark:ring-slate-700 outline-none focus:ring-primary/30">
                    <!option value="" @(string.IsNullOrEmpty(currentSort) || currentSort == "rating" ? "selected" : "")>Đánh giá cao</!option>
                    <!option value="price_asc" @(currentSort == "price_asc" ? "selected" : "")>Giá thấp → cao</!option>
                    <!option value="price_desc" @(currentSort == "price_desc" ? "selected" : "")>Giá cao → thấp</!option>
                    <!option value="newest" @(currentSort == "newest" ? "selected" : "")>Mới nhất</!option>
                </select>
            </div>
        </div>

        <!-- Tour Grid -->
        @if (Model != null && Model.Any())
        {
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8" data-animate="fade-in" data-stagger>
                @foreach (var tour in Model)
                {
                    <a asp-controller="PublicTours" asp-action="Details" asp-route-id="@tour.Id"
                       class="tour-card group bg-white dark:bg-slate-800 rounded-2xl overflow-hidden shadow-sm hover:shadow-2xl hover:shadow-primary/10 transition-all duration-500 border border-slate-100 dark:border-slate-700 hover:-translate-y-1">
                        <div class="relative h-56 overflow-hidden">
                            @if (tour.Images != null && tour.Images.Any())
                            {
                                <img src="@tour.Images.First()" alt="@tour.Name" class="tour-card-img w-full h-full object-cover transition-transform duration-700" />
                            }
                            else
                            {
                                <div class="w-full h-full bg-gradient-to-br from-primary/20 to-blue-500/20 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-6xl text-primary/40">landscape</span>
                                </div>
                            }
                            @if (tour.Price?.Discount > 0)
                            {
                                <div class="absolute top-4 left-4 bg-red-500 text-white text-[11px] font-bold px-3 py-1 rounded-lg shadow-lg">-@tour.Price.Discount%</div>
                            }
                            <div class="absolute top-4 right-4 bg-white/90 dark:bg-slate-800/90 backdrop-blur-sm text-slate-700 dark:text-slate-300 text-[11px] font-bold px-3 py-1 rounded-lg shadow-sm">@(tour.Category ?? "Du lịch")</div>
                        </div>
                        <div class="p-5">
                            <div class="flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400 mb-2">
                                <span class="material-symbols-outlined text-[14px] text-primary">location_on</span>
                                @(tour.Destination?.City ?? "Việt Nam")
                            </div>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-3 line-clamp-2 group-hover:text-primary transition-colors">@tour.Name</h3>
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center gap-3 text-xs text-slate-500 dark:text-slate-400">
                                    <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">schedule</span>@(tour.Duration?.Text ?? $"{tour.Duration?.Days}N{tour.Duration?.Nights}Đ")</span>
                                    <span class="flex items-center gap-1"><span class="material-symbols-outlined text-[14px]">group</span>@tour.MaxParticipants</span>
                                </div>
                                <div class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-amber-400 text-[16px]">star</span>
                                    <span class="text-sm font-bold text-slate-700 dark:text-slate-300">@tour.Rating.ToString("0.0")</span>
                                </div>
                            </div>
                            <div class="flex items-end justify-between pt-4 border-t border-slate-100 dark:border-slate-700">
                                <div>
                                    <p class="text-xs text-slate-400">Từ</p>
                                    <p class="text-xl font-extrabold text-primary">@(tour.Price?.Adult.ToString("N0"))₫</p>
                                </div>
                                <span class="flex items-center gap-1 text-sm font-bold text-primary group-hover:gap-2 transition-all">
                                    Chi tiết <span class="material-symbols-outlined text-[18px]">arrow_forward</span>
                                </span>
                            </div>
                        </div>
                    </a>
                }
            </div>

            <!-- Pagination -->
            @if (totalPages > 1)
            {
                var pagesToShow = new List<int>();
                pagesToShow.Add(1);
                for (int i = Math.Max(2, currentPage - 1); i <= Math.Min(totalPages - 1, currentPage + 1); i++) { pagesToShow.Add(i); }
                if (totalPages > 1) pagesToShow.Add(totalPages);
                pagesToShow = pagesToShow.Distinct().OrderBy(x => x).ToList();

                <div class="flex flex-col items-center gap-4 mt-12">
                    <div class="flex items-center gap-1.5">
                        <a asp-controller="PublicTours" asp-action="Index" asp-route-page="@(Math.Max(1, currentPage - 1))" asp-route-category="@currentCategory" asp-route-search="@currentSearch" asp-route-sort="@currentSort"
                           class="size-10 rounded-xl flex items-center justify-center text-sm transition-all @(currentPage == 1 ? "bg-slate-100 dark:bg-slate-800 text-slate-300 dark:text-slate-600 pointer-events-none" : "bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-700 hover:bg-primary hover:text-white hover:ring-primary")">
                            <span class="material-symbols-outlined text-[18px]">chevron_left</span>
                        </a>
                        @for (int idx = 0; idx < pagesToShow.Count; idx++)
                        {
                            if (idx > 0 && pagesToShow[idx] - pagesToShow[idx - 1] > 1)
                            {
                                <span class="size-10 flex items-center justify-center text-xs text-slate-400">•••</span>
                            }
                            var p = pagesToShow[idx];
                            <a asp-controller="PublicTours" asp-action="Index" asp-route-page="@p" asp-route-category="@currentCategory" asp-route-search="@currentSearch" asp-route-sort="@currentSort"
                               class="size-10 rounded-xl flex items-center justify-center text-sm font-bold transition-all @(p == currentPage ? "bg-primary text-white shadow-lg shadow-primary/25" : "bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-700 hover:bg-primary hover:text-white hover:ring-primary")">
                                @p
                            </a>
                        }
                        <a asp-controller="PublicTours" asp-action="Index" asp-route-page="@(Math.Min(totalPages, currentPage + 1))" asp-route-category="@currentCategory" asp-route-search="@currentSearch" asp-route-sort="@currentSort"
                           class="size-10 rounded-xl flex items-center justify-center text-sm transition-all @(currentPage == totalPages ? "bg-slate-100 dark:bg-slate-800 text-slate-300 dark:text-slate-600 pointer-events-none" : "bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 ring-1 ring-slate-200 dark:ring-slate-700 hover:bg-primary hover:text-white hover:ring-primary")">
                            <span class="material-symbols-outlined text-[18px]">chevron_right</span>
                        </a>
                    </div>
                    <p class="text-xs text-slate-400 dark:text-slate-500">Trang @currentPage / @totalPages</p>
                </div>
            }
        }
        else
        {
            <div class="text-center py-20">
                <span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600 mb-4">search_off</span>
                <h3 class="text-xl font-bold text-slate-700 dark:text-slate-300 mb-2">Không tìm thấy tour nào</h3>
                <p class="text-slate-500 dark:text-slate-400 mb-6">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                <a asp-controller="PublicTours" asp-action="Index" class="inline-flex items-center gap-2 bg-primary text-white px-6 py-3 rounded-xl text-sm font-bold hover:bg-primary-dark transition-all">
                    <span class="material-symbols-outlined text-[18px]">refresh</span> Xem Tất Cả
                </a>
            </div>
        }
    </div>
</section>

@section Scripts {
<script>
    document.getElementById('sort-select').addEventListener('change', function() {
        const url = new URL(window.location);
        if (this.value) url.searchParams.set('sort', this.value);
        else url.searchParams.delete('sort');
        url.searchParams.delete('page');
        window.location = url;
    });
</script>
}
