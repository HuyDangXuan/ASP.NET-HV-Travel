@model HVTravel.Domain.Models.PaginatedResult<HVTravel.Domain.Entities.Booking>
@{
    ViewData["Title"] = "Bookings";

    var bookingStatusMapping = new Dictionary<string, string>
    {
        { "Pending", "Chờ xử lý" },
        { "Paid", "Đã thanh toán" },
        { "Confirmed", "Đã xác nhận" },
        { "Completed", "Hoàn thành" },
        { "Cancelled", "Đã hủy" },
        { "Refunded", "Đã hoàn tiền" }
    };

    var paymentStatusMapping = new Dictionary<string, string>
    {
        { "Unpaid", "Chưa thanh toán" },
        { "Partial", "Thanh toán 1 phần" },
        { "Full", "Đã thanh toán" },
        { "Refunded", "Đã hoàn tiền" }
    };
    
    // Helper function to safely get translated status
    string GetStatusVietnamese(string status)
    {
        if (string.IsNullOrEmpty(status)) return "N/A";
        
        // Try exact match
        if (bookingStatusMapping.ContainsKey(status)) return bookingStatusMapping[status];
        if (paymentStatusMapping.ContainsKey(status)) return paymentStatusMapping[status];

        // Try case-insensitive keys (Title Case approach or iteration)
        foreach(var key in bookingStatusMapping.Keys)
        {
            if(key.Equals(status, StringComparison.OrdinalIgnoreCase)) return bookingStatusMapping[key];
        }
        foreach(var key in paymentStatusMapping.Keys)
        {
            if(key.Equals(status, StringComparison.OrdinalIgnoreCase)) return paymentStatusMapping[key];
        }

        return status;
    }
}

<!-- Page Header -->
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
    <div class="flex flex-col gap-1">
        <nav class="flex items-center gap-2 text-sm text-slate-500">
            <a class="hover:text-primary transition-colors" href="@Url.Action("Index", "Dashboard")">Trang Chủ</a>
            <span class="material-symbols-outlined text-[16px]">chevron_right</span>
            <span class="text-slate-900 dark:text-white font-medium">Đơn Đặt Vé</span>
        </nav>
        <h1 class="text-2xl font-bold text-slate-900 dark:text-white">Quản Lý Đơn Đặt Vé</h1>
    </div>
    <div class="flex gap-2">
        <button class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 rounded-lg text-sm font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-50 transition-colors">
            <span class="material-symbols-outlined text-lg">download</span>
            Xuất File
        </button>
    </div>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex items-center gap-4 relative overflow-hidden group">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-primary/5 rounded-full group-hover:bg-primary/10 transition-colors"></div>
        <div class="bg-primary/10 text-primary p-3 rounded-xl relative z-10">
            <span class="material-symbols-outlined">today</span>
        </div>
        <div class="relative z-10">
            <p class="text-slate-500 dark:text-slate-400 text-xs font-semibold uppercase tracking-wider">Đơn Đặt Hôm Nay</p>
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">@ViewBag.TodayBookingsCount</h3>
            <p class="text-green-500 text-xs font-bold mt-1">Hôm nay</p>
        </div>
    </div>
    <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex items-center gap-4 relative overflow-hidden group">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-orange-500/5 rounded-full group-hover:bg-orange-500/10 transition-colors"></div>
        <div class="bg-orange-100 text-orange-600 p-3 rounded-xl relative z-10">
            <span class="material-symbols-outlined">payments</span>
        </div>
        <div class="relative z-10">
            <p class="text-slate-500 dark:text-slate-400 text-xs font-semibold uppercase tracking-wider">Thanh Toán Chờ Xử Lý</p>
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">@ViewBag.PendingPaymentCount</h3>
            <p class="text-slate-400 text-xs mt-1">@((ViewBag.PendingPaymentTotal ?? 0).ToString("N0")) ₫ tổng cộng</p>
        </div>
    </div>
    <div class="bg-white dark:bg-surface-dark p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 flex items-center gap-4 relative overflow-hidden group">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-red-500/5 rounded-full group-hover:bg-red-500/10 transition-colors"></div>
        <div class="bg-red-100 text-red-600 p-3 rounded-xl relative z-10">
            <span class="material-symbols-outlined">assignment_return</span>
        </div>
        <div class="relative z-10">
            <p class="text-slate-500 dark:text-slate-400 text-xs font-semibold uppercase tracking-wider">Yêu Cầu Hoàn Tiền</p>
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">@ViewBag.RefundRequestCount</h3>
            <p class="text-red-500 text-xs font-bold mt-1">Cần xử lý</p>
        </div>
    </div>
</div>

    <!-- Filters Form -->
    <form method="get" id="filter-form" class="bg-white dark:bg-surface-dark p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 mb-6 flex flex-wrap items-center gap-4">
        <!-- Hidden Inputs for State -->
        <input type="hidden" name="status" value="@ViewData["CurrentStatus"]" id="status-input">
        <input type="hidden" name="startDate" value="@ViewData["CurrentStartDate"]" id="startDate-input">
        <input type="hidden" name="endDate" value="@ViewData["CurrentEndDate"]" id="endDate-input">
        <input type="hidden" name="pageSize" value="@ViewData["CurrentPageSize"]" id="pageSize-input">

        <div class="flex-1 min-w-[200px]">
            <div class="relative">
                <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-lg">search</span>
                <input name="searchString" value="@ViewData["CurrentSearch"]" class="w-full pl-10 pr-4 py-2.5 bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 rounded-xl text-sm focus:ring-primary focus:border-primary" placeholder="Tìm mã vé, tên khách, email..." type="text" />
            </div>
        </div>
        <div class="flex items-center gap-3">
            <!-- Custom Status Filter Dropdown -->
            <div class="relative group">
                <button type="button" onclick="toggleBookingFilter('status-dropdown')" class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm py-2.5 px-4 focus:ring-primary focus:border-primary min-w-[160px] hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <span id="status-label" class="text-slate-700 dark:text-slate-300 font-medium">@(string.IsNullOrEmpty(ViewData["CurrentStatus"]?.ToString()) || ViewData["CurrentStatus"]?.ToString() == "all" ? "Trạng thái" : GetStatusVietnamese(ViewData["CurrentStatus"]?.ToString()))</span>
                    <span class="material-symbols-outlined text-[20px] ml-auto text-slate-500">expand_more</span>
                </button>
                <div id="status-dropdown" class="absolute top-full mt-2 w-full bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-100 dark:border-slate-800 z-30 hidden origin-top transition-all">
                    <div class="p-1.5 flex flex-col gap-1">
                        <button type="button" onclick="applyStatus('all', 'Tất cả')" class="flex items-center gap-2 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors text-left w-full">
                            <span class="material-symbols-outlined text-[18px] text-slate-400">grid_view</span>
                            Tất cả
                        </button>
                        <button type="button" onclick="applyStatus('paid', 'Đã thanh toán')" class="flex items-center gap-2 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors text-left w-full">
                             <span class="w-2 h-2 rounded-full bg-green-500"></span>
                            Đã thanh toán
                        </button>
                        <button type="button" onclick="applyStatus('pending', 'Chờ xử lý')" class="flex items-center gap-2 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors text-left w-full">
                            <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                            Chờ xử lý
                        </button>
                         <button type="button" onclick="applyStatus('cancelled', 'Đã hủy')" class="flex items-center gap-2 px-3 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors text-left w-full">
                            <span class="w-2 h-2 rounded-full bg-red-500"></span>
                            Đã hủy
                        </button>
                    </div>
                </div>
            </div>
            <!-- Custom Date Range Picker -->
            <div class="relative group">
                 <button type="button" onclick="toggleBookingFilter('date-dropdown')" class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-xl text-sm py-2.5 px-4 focus:ring-primary focus:border-primary min-w-[240px] hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
                    <span class="material-symbols-outlined text-slate-400 text-[20px]">calendar_today</span>
                    <span id="date-label" class="text-slate-700 dark:text-slate-300 font-medium">
                        @(string.IsNullOrEmpty(ViewData["CurrentStartDate"]?.ToString()) ? "Chọn ngày" : ViewData["CurrentStartDate"] + (string.IsNullOrEmpty(ViewData["CurrentEndDate"]?.ToString()) ? "" : " - " + ViewData["CurrentEndDate"]))
                    </span>
                </button>
                <div id="date-dropdown" class="absolute right-0 top-full mt-2 w-80 bg-white dark:bg-slate-900 rounded-xl shadow-xl border border-slate-100 dark:border-slate-800 z-30 hidden origin-top-right transition-all">
                    <div class="p-4">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-sm font-bold text-slate-900 dark:text-white">Chọn Thời Gian</span>
                            <div class="flex gap-1">
                                 <button type="button" onclick="changeMonth(-1)" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 hover:text-primary transition-colors"><span class="material-symbols-outlined text-[20px]">chevron_left</span></button>
                                 <span id="calendar-month-year" class="text-sm font-medium text-slate-700 dark:text-slate-300 leading-7 min-w-[100px] text-center">Tháng 10, 2023</span>
                                 <button type="button" onclick="changeMonth(1)" class="p-1 rounded hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 hover:text-primary transition-colors"><span class="material-symbols-outlined text-[20px]">chevron_right</span></button>
                            </div>
                        </div>
                        <!-- Calendar Grid -->
                        <div class="grid grid-cols-7 gap-1 text-center mb-2">
                            <span class="text-xs text-slate-400 font-medium py-2">T2</span>
                            <span class="text-xs text-slate-400 font-medium py-2">T3</span>
                            <span class="text-xs text-slate-400 font-medium py-2">T4</span>
                            <span class="text-xs text-slate-400 font-medium py-2">T5</span>
                            <span class="text-xs text-slate-400 font-medium py-2">T6</span>
                            <span class="text-xs text-slate-400 font-medium py-2">T7</span>
                            <span class="text-xs text-slate-400 font-bold text-red-500 py-2">CN</span>
                        </div>
                        <div id="calendar-days" class="grid grid-cols-7 gap-1 text-center mb-4">
                            <!-- Dynamic Days will be inserted here -->
                        </div>
                        
                        <div class="flex gap-2">
                             <button type="button" onclick="clearDateFilter()" class="flex-1 py-2 text-xs font-bold text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 transition-colors bg-slate-50 dark:bg-slate-800 rounded-lg">Hủy</button>
                             <button type="button" onclick="applyDateFilter()" class="flex-1 py-2 text-xs font-bold text-white bg-primary hover:bg-primary-dark rounded-lg shadow-sm shadow-primary/30 transition-all">Áp Dụng</button>
                        </div>
                    </div>
                </div>
            </div>
             <button type="submit" class="h-10 px-4 bg-primary text-white text-sm font-bold rounded-xl hover:bg-primary-dark transition-colors shadow-sm shadow-primary/30">
                Lọc
            </button>
        </div>
    </form>

<!-- Bookings Table -->
<div class="bg-white dark:bg-surface-dark rounded-2xl shadow-sm border border-slate-100 dark:border-slate-800 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-slate-50/50 dark:bg-slate-800/50 text-slate-500 dark:text-slate-400 text-xs uppercase tracking-wider font-bold">
                    <th class="p-4 pl-6 cursor-pointer hover:text-primary transition-colors select-none" onclick="applySort('@ViewBag.DateSortParm')">
                        <div class="flex items-center gap-1">
                            Mã Đơn
                             @if(string.IsNullOrEmpty(ViewBag.CurrentSort)) {
                                <span class="material-symbols-outlined text-[16px]">arrow_downward</span> <!-- Default Date Desc -->
                            } else if (ViewBag.CurrentSort == "date_asc") {
                                 <span class="material-symbols-outlined text-[16px] text-primary">arrow_upward</span>
                            } else {
                                <span class="material-symbols-outlined text-[16px] opacity-30">unfold_more</span>
                            }
                        </div>
                    </th>
                    <th class="p-4">Khách hàng</th>
                    <th class="p-4">Tour</th>
                    <th class="p-4 text-center">Số lượng</th>
                    <th class="p-4 cursor-pointer hover:text-primary transition-colors select-none" onclick="applySort('@ViewBag.TotalSortParm')">
                         <div class="flex items-center gap-1">
                            Tổng tiền
                            @if (ViewBag.CurrentSort == "total") {
                                <span class="material-symbols-outlined text-[16px] text-primary">arrow_upward</span>
                            } else if (ViewBag.CurrentSort == "total_desc") {
                                 <span class="material-symbols-outlined text-[16px] text-primary">arrow_downward</span>
                            } else {
                                <span class="material-symbols-outlined text-[16px] opacity-30">unfold_more</span>
                            }
                        </div>
                    </th>
                    <th class="p-4">Thanh toán</th>
                    <th class="p-4 cursor-pointer hover:text-primary transition-colors select-none" onclick="applySort('@ViewBag.StatusSortParm')">
                         <div class="flex items-center gap-1">
                            Trạng thái
                            @if (ViewBag.CurrentSort == "status") {
                                <span class="material-symbols-outlined text-[16px] text-primary">arrow_upward</span>
                            } else if (ViewBag.CurrentSort == "status_desc") {
                                 <span class="material-symbols-outlined text-[16px] text-primary">arrow_downward</span>
                            } else {
                                <span class="material-symbols-outlined text-[16px] opacity-30">unfold_more</span>
                            }
                        </div>
                    </th>
                    <th class="p-4 pr-6 text-right">Thao tác</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800 text-sm">
                @foreach (var item in Model.Items)
                {
                    <tr class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                        <td class="p-4 pl-6 font-mono font-semibold text-primary">#@item.BookingCode</td>
                        <td class="p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-9 h-9 rounded-full bg-primary/10 flex items-center justify-center text-primary font-bold text-xs uppercase border-2 border-white dark:border-slate-700 shadow-sm">
                                    @if (!string.IsNullOrEmpty(item.ContactInfo?.Name) && item.ContactInfo.Name.Length >= 2)
                                    {
                                        @item.ContactInfo.Name.Substring(0, 2)
                                    }
                                    else
                                    {
                                        <span>KH</span>
                                    }
                                </div>
                                <div>
                                    <p class="font-bold text-slate-900 dark:text-white">@item.ContactInfo?.Name</p>
                                    <p class="text-xs text-slate-500">@item.ContactInfo?.Email</p>
                                </div>
                            </div>
                        </td>
                        <td class="p-4">
                            <p class="font-medium text-slate-700 dark:text-slate-300">@item.TourSnapshot?.Name</p>
                            <p class="text-xs text-slate-400">Khởi hành: @(item.TourSnapshot?.StartDate.ToString("dd/MM/yyyy") ?? "Updating...")</p>
                        </td>
                        <td class="p-4 text-center font-medium">@item.ParticipantsCount</td>
                        <td class="p-4 font-bold text-slate-900 dark:text-white">@item.TotalAmount.ToString("N0") ₫</td>
                        <td class="p-4">
                           @* Mocking Payment Method based on status for now as it's not in base entity directly, or assume Transfer *@
                           <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded bg-slate-100 dark:bg-slate-700 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-xs">payments</span>
                                </div>
                                <span class="text-xs font-medium text-slate-600 dark:text-slate-400">@GetStatusVietnamese(item.PaymentStatus)</span>
                            </div>
                        </td>
                        <td class="p-4">
                            @if (item.Status == "Paid" || item.Status == "Completed" || item.Status == "Confirmed")
                            {
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[11px] font-bold bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 border border-green-200 dark:border-green-900">
                                    <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> @GetStatusVietnamese(item.Status)
                                </span>
                            }
                            else if (item.Status == "Pending")
                            {
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[11px] font-bold bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400 border border-yellow-200 dark:border-yellow-900">
                                    <span class="w-1.5 h-1.5 rounded-full bg-yellow-500"></span> @GetStatusVietnamese(item.Status)
                                </span>
                            }
                            else if (item.Status == "Cancelled")
                            {
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[11px] font-bold bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 border border-red-200 dark:border-red-900">
                                    <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> @GetStatusVietnamese(item.Status)
                                </span>
                            }
                            else
                            {
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-[11px] font-bold bg-slate-100 text-slate-700 dark:bg-slate-800 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
                                    <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> @GetStatusVietnamese(item.Status)
                                </span>
                            }
                        </td>
                        <td class="p-4 pr-6 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <a asp-action="Details" asp-route-id="@item.Id" class="w-8 h-8 rounded-lg flex items-center justify-center bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-400 transition-colors" title="Xem chi tiết">
                                    <span class="material-symbols-outlined text-lg">visibility</span>
                                </a>
                                <a asp-action="Edit" asp-route-id="@item.Id" class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-50 hover:bg-blue-100 dark:bg-blue-900/30 dark:hover:bg-blue-900/50 text-blue-600 dark:text-blue-400 transition-colors" title="Chỉnh sửa">
                                    <span class="material-symbols-outlined text-lg">edit</span>
                                </a>
                                <button class="w-8 h-8 rounded-lg flex items-center justify-center bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-600 dark:text-red-400 transition-colors" title="Xóa">
                                    <span class="material-symbols-outlined text-lg">delete</span>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="p-6 border-t border-slate-100 dark:border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-50/30 dark:bg-slate-800/20">
        @{
            var startItem = (Model.PageIndex - 1) * Model.PageSize + 1;
            var endItem = Math.Min(Model.PageIndex * Model.PageSize, Model.TotalCount);
            int[] pageSizes = { 10, 15, 20, 50, 100 };
            int currentPageSize = (int?)ViewData["CurrentPageSize"] ?? 10;
        }
        <div class="flex items-center gap-4">
             <p class="text-xs text-slate-500 dark:text-slate-400">Hiển thị <span class="font-bold text-slate-900 dark:text-white">@startItem - @endItem</span> trong số <span class="font-bold text-slate-900 dark:text-white">@Model.TotalCount</span> Vé</p>
             <div class="flex items-center gap-2">
                 <label for="pageSize" class="text-xs font-medium text-slate-500 dark:text-slate-400">Hiển thị:</label>
                 <div class="relative group">
                     <select id="pageSize" onchange="changePageSize(this.value)" 
                             class="appearance-none h-9 pl-3 pr-10 py-1 text-xs font-bold bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 rounded-lg focus:ring-2 focus:ring-primary/20 focus:border-primary outline-none transition-all cursor-pointer shadow-sm hover:border-primary/50">
                         @foreach(var size in pageSizes)
                         {
                             if(size == currentPageSize)
                             {
                                 <option value="@size" selected>@size</option>
                             }
                             else
                             {
                                 <option value="@size">@size</option>
                             }
                         }
                     </select>
                     <span class="absolute right-2.5 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400 group-hover:text-primary transition-colors flex items-center">
                        <span class="material-symbols-outlined text-[18px]">expand_more</span>
                    </span>
                 </div>
             </div>
        </div>

        <div class="flex items-center gap-2">
            <button onclick="location.href='@Url.Action("Index", new { page = Model.PageIndex - 1, status = ViewData["CurrentStatus"], pageSize = currentPageSize, searchString = ViewData["CurrentSearch"], startDate = ViewData["CurrentStartDate"], endDate = ViewData["CurrentEndDate"] })'" @(Model.HasPreviousPage ? "" : "disabled") class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-400 hover:bg-white dark:hover:bg-slate-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-lg">chevron_left</span>
            </button>
            
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                if (Math.Abs(i - Model.PageIndex) <= 2 || i == 1 || i == Model.TotalPages)
                {
                    if (i == Model.PageIndex)
                    {
                         <button class="w-8 h-8 rounded-lg bg-primary text-white text-xs font-bold shadow-sm shadow-primary/30">@i</button>
                    }
                    else
                    {
                        <button onclick="location.href='@Url.Action("Index", new { page = i, status = ViewData["CurrentStatus"], pageSize = currentPageSize, searchString = ViewData["CurrentSearch"], startDate = ViewData["CurrentStartDate"], endDate = ViewData["CurrentEndDate"] })'" class="w-8 h-8 rounded-lg hover:bg-white dark:hover:bg-slate-800 text-slate-600 dark:text-slate-400 text-xs font-bold transition-colors">@i</button>
                    }
                }
                else if (Math.Abs(i - Model.PageIndex) == 3)
                {
                    <span class="text-slate-400 text-xs">...</span>
                }
            }

            <button onclick="location.href='@Url.Action("Index", new { page = Model.PageIndex + 1, status = ViewData["CurrentStatus"], pageSize = currentPageSize, searchString = ViewData["CurrentSearch"], startDate = ViewData["CurrentStartDate"], endDate = ViewData["CurrentEndDate"] })'" @(Model.HasNextPage ? "" : "disabled") class="p-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-400 hover:bg-white dark:hover:bg-slate-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                <span class="material-symbols-outlined text-lg">chevron_right</span>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function toggleBookingFilter(id) {
            const el = document.getElementById(id);
            if (el) {
                el.classList.toggle('hidden');
            }
        }

        function applyStatus(value, label) {
            // Update label
            const labelEl = document.getElementById('status-label');
            if (labelEl) labelEl.innerText = label;

            // Update hidden input
            const inputEl = document.getElementById('status-input');
            if (inputEl) inputEl.value = value;

            // Close dropdown
            toggleBookingFilter('status-dropdown');

            // Optional: Auto submit or wait for button
            // document.getElementById('filter-form').submit(); 
        }

        function changePageSize(size) {
            const url = new URL(window.location.href);
            url.searchParams.set('pageSize', size);
            url.searchParams.set('page', 1); // Reset to page 1
            window.location.href = url.toString();
        }

        function clearDateFilter() {
             document.getElementById('startDate-input').value = '';
             document.getElementById('endDate-input').value = '';
             document.getElementById('date-label').innerText = 'Chọn ngày';
             toggleBookingFilter('date-dropdown');
             // document.getElementById('filter-form').submit();
        }

        // Calendar Logic
        let currentDate = new Date();
        // Parse existing values if any
        let selectedStartDate = null;
        let selectedEndDate = null; // Currently logic supports single date or simple range mocking

        function renderCalendar() {
            const monthYearEl = document.getElementById('calendar-month-year');
            const daysEl = document.getElementById('calendar-days');
            
            if (!daysEl) return;

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Set Header
            const monthNames = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
            monthYearEl.innerText = `${monthNames[month]}, ${year}`;

            daysEl.innerHTML = "";

            // First day of mon (0=Sun, 1=Mon...)
            const firstDay = new Date(year, month, 1).getDay();
            const startOffset = (firstDay + 6) % 7; 
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            // Previous Month Padding
            for (let i = 0; i < startOffset; i++) {
                const dayNum = prevMonthDays - startOffset + 1 + i;
                const span = document.createElement('span');
                span.className = "h-8 w-8 flex items-center justify-center text-xs text-slate-300 dark:text-slate-600";
                span.innerText = dayNum;
                daysEl.appendChild(span);
            }

            // Current Month Days
            for (let i = 1; i <= daysInMonth; i++) {
                const btn = document.createElement('button');
                btn.type = "button"; // Prevent form submit
                btn.className = "h-8 w-8 rounded-full text-sm flex items-center justify-center transition-all hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-700 dark:text-slate-300";
                btn.innerText = i;
                
                // Check if today
                const today = new Date();
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                     btn.classList.add('border', 'border-primary', 'font-bold', 'text-primary');
                }
                
                // Highlight selected (Simple visual logic for now)
                // TODO: Handle range visual proper
                
                btn.onclick = (e) => {
                    e.stopPropagation(); 
                    // Clear other selections styling
                    const allBtns = daysEl.querySelectorAll('button');
                    allBtns.forEach(b => {
                        b.classList.remove('bg-primary', 'text-white', 'hover:bg-primary-dark');
                        b.classList.add('hover:bg-slate-100', 'dark:hover:bg-slate-800', 'text-slate-700', 'dark:text-slate-300');
                        if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                             // retain border
                        }
                    });
                    
                    // Select this one
                    btn.classList.remove('hover:bg-slate-100', 'dark:hover:bg-slate-800', 'text-slate-700', 'dark:text-slate-300');
                    btn.classList.add('bg-primary', 'text-white', 'hover:bg-primary-dark');
                    selectedStartDate = new Date(year, month, i);
                    // For simplicity, make start = end for single day filter unless we build complex range UI
                    selectedEndDate = selectedStartDate; 
                };

                daysEl.appendChild(btn);
            }
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }
        
        function applyDateFilter() {
             toggleBookingFilter('date-dropdown');
             if(selectedStartDate) {
                 const day = selectedStartDate.getDate().toString().padStart(2, '0');
                 const m = (selectedStartDate.getMonth() + 1).toString().padStart(2, '0');
                 const y = selectedStartDate.getFullYear();
                 const dateStr = `${day}/${m}/${y}`; // Matches typical input format, or use yyyy-MM-dd if simplified
                 // Let's use ISO or simple, controller parses simple text
                 // Controller uses DateTime.TryParse. "dd/MM/yyyy" works depends on culture, or "yyyy-MM-dd".
                 // Let's use standard ISO yyyy-MM-dd for hidden input value to be safe, label is display.
                 
                 const isoDate = `${y}-${m}-${day}`;
                 
                 document.getElementById('date-label').innerText = dateStr;
                 document.getElementById('startDate-input').value = isoDate;
                 document.getElementById('endDate-input').value = isoDate; // Single day filter
             }
        }

        // Initialize Calendar
        renderCalendar();

        function applySort(sortOrder) {
            const form = document.getElementById('filter-form');
            // Create or update hidden input for sortOrder
            let input = document.getElementById('sortOrder-input');
            if (!input) {
                input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'sortOrder';
                input.id = 'sortOrder-input';
                form.appendChild(input);
            }
            input.value = sortOrder;
            form.submit();
        }
    </script>
}
